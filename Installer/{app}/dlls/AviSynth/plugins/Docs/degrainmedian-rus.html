<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ru">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
  <link rel="stylesheet" type="text/css" href="../avisynth.css">
  <title>DeGrainMedian плагин для AviSynth</title>
</head>

<body>
<h1>DeGrainMedian</h1>
<h2>Пространственно-временной ограниченно медианный фильтр для
удаления зерна</h2>

<p>Плагин для <a href="http://www.avisynth.org">Avisynth 2.5</a><br>
Версия 0.8.2<br>
Авторские права (C)2004-2006 Александр Г. Балахнин (aka Fizick).<br>
<a href="http://avisynth.org.ru">http://avisynth.org.ru</a>
</p>
<p> DeGrainMedian плагин разработан главным образом для удаления
зернистости пленок, но может быть использован для общего понижения шума.</p>
<p> Он использует
некоторый пространственно-временной ограниченно медианный метод.</p>

<h2>Синтаксис</h2>

<p><code>DeGrainMedian</code>(<var>clip, int
"limitY", int "limitUV", int "mode", bool "interlaced"</var>)</p>

<h3>Параметры фильтра</h3>
<p>первый параметр как всегда входной клип, по умолчанию последний (last),</p>
<p><var>limitY</var> (от 0 до 255, по умолчанию=4) -
предел коррекция яркости пиксела,</p>
<p><var>limitUV</var>
(от 0 до 255, по умолчанию=6) - предел коррекции цвета пиксела</p>
<p><var>mode</var>
(от 0 до 5, по умолчанию=1) - режим обработки (чем больше, тем слабее)</p>
<p><var>interlaced</var>
(true или false, по умолчанию=false) - обрабатывать клип как
чересстрочный<br>
</p>

<p>
<var>norow</var> 
(true или false, по умолчанию=false) - не использовать ту же строку для пространстственного фильтра
</p>

<h2>Использование для удаления зерна и шума</h2>

<p>Загрузите плагин,
настройте величины параметров подходящие для вашего клипа. </p>
<p>Установите значение
параметра <var>limitY</var> типично около 2-8 (компромисс
между удалением шума и размыванием). </p>
<p>Кажется, что большие
значения параметра <var>limitUV</var>
для цвета (4-15) часто вполне безопасны.</p>
<p>Установите параметр выбора режима <var>mode</var>
в большую величину если вы находите картинку слишком размытой
(попробуйте!). </p>
<p>Чем больше номер режима <var>mode</var>, тем большее значение
параметров пределов limit безопасны.</p>
<p>Кажется, что режим <var>mode</var>=1 или 2
- хороший компромисс, но это зависит от источника.</p>
<p>С режимом <var>mode=5</var>
изменения результата невидимы, но некоторые "горячие" пикселы все же удаляются.</p>

<p>Опция <var>norow</var>=true полезна для видео с горизотальными шумовыми полосами, 
такими как аналоговый ТВ или VHS захват. </p>

<h2>Примеры простых скриптов (используйте правильные пути к файлам):</h2>

<h4>Слабая фильтрация но полезная для удаления горячих пикселов:</h4>

<pre>Avisource("dvd-input.avi")
loadplugin("DeGrainMedian.dll")
DeGrainMedian(limitY=5,limitUV=5,mode=3)</pre>

<h4>Двух-шаговая фильтрация для более сильного удаления шума:</h4>

<pre>Avisource("input.avi")
loadplugin("DeGrainMedian.dll")
DeGrainMedian(limitY=2,limitUV=3,mode=1)
DeGrainMedian(limitY=2,limitUV=3,mode=1)</pre>

<h4>Сильная фильтрация для удаления большого зерна:</h4>

<pre>Avisource("analog-input.avi")
loadplugin("DeGrainMedian.dll")
DeGrainMedian(limitY=5,limitUV=7,mode=0)</pre>

<h4>Фильтрация для удаления горизонтальных шумовых полосок:</h4>

<pre>Avisource("analog-input.avi")
loadplugin("DeGrainMedian.dll")
DeGrainMedian(limitY=5,limitUV=7,mode=1, norow=true)</pre>

<h2> Технические детали</h2>
<p> Плагин базируется в основном на двух идеях, используемых на двух
стадиях обработки.</p>

<h4> Стадия детектирования</h4>
<p> Первая идея
взята из плагина <code>STMedianFilter</code> от Тома Барри
(Tom Barry). Я также использую часть
его замечательно оптимизированного кода и привожу здесь часть
прекрасной документации (немного отредактированной
и коряво переведенной на русский, как и другие цитаты) :</p>
<p>"STMedianFilter это (слегка скомпенсированный
по движению) пространственно/временной медианный фильтр.<br>
Он довольно тонкозернистый, используя только соседние пикселы в
пространстве и во времени, так что он смотрит смежные 26 позиций чтобы
фильтровать каждую позицию. Он фильтрует как яркость, так и цветность...<br>
...Простой медианный фильтр это просто шаг обрезки,
когда величина устанавливается, чтобы не превышать верхний и нижний
пороги ее соседей. (<i>вероятно более строго: медиана есть средний
член ранжированного (упорядоченного по величине) ряда - Fizick</i>).<br>
Например, если вы имеете 3 пиксела в строке, которые
имеют величины &lt;5,8,7&gt;, то вы могли бы обрезать
центральную
величину до не выходящей из пределов снизу 5 или сверху 7, то есть вы
установили бы ее равной 7.<br>
Теперь представьте что вы имели бы небольшой видео
экран 3x3, подобно поверхности кубика Рубика. Представьте предыдущий
кадр был бы нижним слоем кубика, текущий кадр был бы средним слоем, и
следующий кадр был бы верхним. <br>
Тогда текущий центральный пиксел был бы в центре
кубика Рубика и было бы 13 путей (способов) как вы могли бы
провести линию через него и пару ближайших соседей. <br>
Что я (<i>и я - Fizick</i>) делал бы было сравнить
каждую из этих пар соседей чтобы увидеть какая пара наиболее
согласуется по величине. Я (<i>и я - Fizick</i>)
использовал эту пару,
чтобы обрезать величину центрально пиксела." (<i>Конец цитаты Tom
Barry</i>).<br>
</p>
<p> Очень интересный плагин <code>RemoveGrain</code> от Kassandro
в его режиме mode=9 работает подобно <code>STMedianFilter</code>
на этой стадии но в только в пространственной плоскости
(не во временной). <br>
Он затем изменяет пиксел в это значение соседей (методом минимакса). <br>
Но он не может удалить зернистость среднего размера с моих
плохих пленок. <br>
<code>RemoveGrain</code> рассматривается Kassandro как
префильтр для плагина
<code>RemoveDirt</code>, он говорит в документации: <br>
"Если зерно слишком грубое, RemoveGrain может только частично удалить
его или не может удалить его вовсе." <br>
(<i> Конец цитаты Kassandro</i>) <br>
Кажется, что это главным образом из-за отсутствия пространственной
информации от соседних кадров.</p>
<p>С версии 0.2, я добавил
к DeGrainMedian также некоторые другие более безопасные режимы
обработки 1-4 (позднее 5) (код заимствован из RemoveGrain).</p>
<p>Мы рассматриваем тот же куб 3x3x3.<br>
Новое значение пиксела-кандидата (newp) обрезается величинами соседей 
из пары (bound1 и bound2).<br>
Однако mode1-mode4 используют более безопасные критерии (веса) оптимальной
пары пикселов,<br>
Мы также учитываем разность новой величины 
от старой величины центрального пиксела (oldp).</p>
<p>Mode=0 плагина
DeGrainMedian (подобно mode=9 RemoveGrain) использует 
вес=|bound1 - bound2|, это сильнейший режим.<br>
Mode=1 плагина
DeGrainMedian (сильнее mode=8 RemoveGrain) использует 
вес=|oldp - newp|+4* |bound1 - bound2|<br>
Mode=2 плагина
DeGrainMedian (подобно mode=8 RemoveGrain) использует 
вес=|oldp - newp|+2* |bound1 - bound2|<br>
Mode=3 плагина
DeGrainMedian (подобно mode=7 RemoveGrain) использует 
вес=|oldp - newp|+ |bound1 - bound2|<br>
Mode=4 плагина
DeGrainMedian (подобно mode=6 RemoveGrain) использует 
вес=2*|oldp- newp|+ |bound1 - bound2|<br>
Mode=5 плагина
DeGrainMedian (подобно mode=5 RemoveGrain) использует 
вес=|oldp - newp|, это слабейший (и безопасный) режим.</p>

<p>Опция <var>norow</var> исключает горизонтальную пару пикселов того же кадра
из рассмотрения, и фильтр учитывает только 12 пар.</p>

<h4> Стадия очистки</h4>
<p> STMedianFilter
на второй стадии не фильтрует пиксел, если тот изменился бы более чем
на некоторое пороговое значение.<br>
(Более точно, он сначала делает временное детектирование медианы и
пороговую проверку, с последующим пространственным <br>
детектированием медианы и пороговой проверкой)<br>
</p>
<p> Большинство шумоподавителей также не фильтруют
пикселы с большим шумом
(большой разностью яркостей).<br>
Но как такие одиночные пикселы очень заметны на плоский сглаженный
областях, <br>
так и группы таких пикселов формируют очень неприятные краевые
артефакты. </p>
<p>Кроме того,
чисто темпоральные (временные, динамические) шумоподавители часто
производят призраки даже при не очень больших порогах.</p>
<p> DeGrainMedian на этой второй стадии использует другой
(отличный) метод обработки пикселов.</p>
<p>Здесь я использую вторую идею,
заимствованную из плагина <code>Dust</code> от Steady.
Смотри часть документации
<code>Dust</code> здесь:</p>
<p>"Limit=5<br>
Устанавливает силу временной фильтрации. 
(насколько много он может изменить оригинальный
пиксел)." (<i>Конец цитаты Steady</i>).</p>
<p> Таким образом, если фильтрованный пиксел изменился
бы более чем на некоторый порог (предел, ограничение), то он НЕ будет
восстановлен в DeGrainMedian к оригинальной величине, а будет изменен,
но на ОГРАНИЧЕННУЮ величину.<br>
DeGrainMedian плагин фильтрует
ВСЕ пикселы, но с ограниченной силой.<br>
Следовательно, все
зерна и царапины будут (частично или полностью) сглажены. </p>
<p>Фильтр почти не
производит краевых артефактов.</p>
<p>Призраки также
минимальны, так ка фильтр автоматически переключается к
пространственному сглаживанию, как наиболее близкой паре соседей по
величине.</p>
<p>Вы можете выбрать один
из 6 режимов обработки, от сильной (но сглаживающей) до слабой (но
резкой). </p>
<p> Таким образом, <code>DeGrainMedian</code> имеет скорость <code>STMedianFilter</code>
(правда) и
силу <code>Dust</code> (правда по ограниченной величине :-)!<br>
Это почти не шутка :-).</p>
<p>Он может  сильно увеличичить сжимаемость.</p>

<p> Что же плохо, в самом деле?</p>
<ol>
  <li>Некоторое размытие
(вы хотели шумопонижение без этого ? :-) .</li>
  <li>Он не может
произвести полностью гладкую картинку, некоторый шум всегда остается
(вы любите сверх сглаженные и блочные сжатые клипы ?) .</li>
  <li>Компенсация движения ограничена диапазоном 1 пиксел (конечно, это НЕ как
Dust, но что о внешней компенсации движения ?).</li>
</ol>
<p>Серьезно,
это не супер фильтр и еще экспериментальный, но для моих зернистых
пленок, он производит вполне хорошие результаты.<br>
Сначала я
разрабатывал его как префильтр (для Vaguedenoiser и т.п.), но
кажется теперь, что иногда он может быть использован самостоятельно...
</p>
<p>Возможно, он может
помочь кому-нибудь еще. Вот почему я выпускаю его.</p>
<p> Некоторое
замечание. При <var>limitY</var>=255,
<code>DeGrainMedian</code> должен давать тот же (или
подобный) выход, <br>
как <code>STMedianFilter</code> с порогами=255 (и с теми
же артефактами),
но это не так сейчас, <br>
возможно из-за некоторой ошибки или ошибок :-(<br>
Исправление:
Это правда теперь - была ошибка в STMedianFilter , и я исправил ее в
версии 1.0.3.
</p>

<h2> Совместное использование</h2>
<p> Он должен быть применен до других
шумоподавляющих фильтров.</p>
<p>Иногда я использую в скрипте два DegrainMedian c пониженными пределами
чтобы повысить степень удаления шума.</p>
<p>Лучшие результаты для реставрации пленок с Avisynth
могут быть достигнуты
с моим плагином компенсацией глобального движения DePan.</p>
<h2>Особенности и ограничения текущей версии </h2>
Работает только в цветовых форматах YV12 и YUY2.
<ol>
  <li> Требует процессор P-III, Athlon, или лучше. Требуется
поддержка
SSEMMX (Integer SSE).</li>
  <li> Нет детектора изменения сцены. Но я не вижу призраков, так
как фильтр переключается на пространственную пару пикселов.</li>
  <li> Первая и последняя строки (пары строк для чересстрочного)
каждого
кадра не фильтруются.</li>
  <li> Первые и последние 8 (YV12) или 4 (YUY2) пиксела в каждой
строке
фильтруются с более простым (в той же колонке) методом.</li>
  <li> Фильтрация цветности для YUY2 также только по той же
колонке.</li>
  <li> Первый и последний кадр не фильтруется. </li>
  <li> Тестирован с Avisynth
2.5.5.</li>
  <li>Очень быстрый.</li>
</ol>
<h2> Дополнительная информация</h2>
<p>Смотри форум doom9, специальная ветка (на английском):&nbsp;<br>
<a href="http://forum.doom9.org/showthread.php?s=&amp;threadid=80834">http://forum.doom9.org/showthread.php?s=&amp;threadid=80834</a><br>
</p>
Или обращайтесь на русскоязычный форум, например ветка
"Экстремальный Ависинт"
<a href="http://forum.ixbt.com/topic.cgi?id=29:9331">http://forum.ixbt.com/topic.cgi?id=29:9331</a>
<h2>Компиляция</h2>
<p>Я использую
свободный MS VC++ Toolkit 2003 и MS Platform SDK.</p>
<p>Используйте make файл
проекта "makefile" с командой:</p>
<p>nmake</p>
<p>(замечание: скопируйте потерянный nmake.exe и cvtres.exe из Platform SDK папки
Bin\win64 в папку Bin ).
</p>

<h2>Лицензия</h2>
<p>Данная программа представляет собой свободно распространяемый<br>
программный продукт; вы можете распространять ее далее и\или изменять<br>
на условиях Стандартной публичной лицензии GNU, опубликованной<br>
"Free Software Foundation" -- либо ее версии номер 2, либо (по вашему<br>
выбору) любой более поздней ее версии.<br>
Распространяя данный программный продукт, мы надеемся что он окажется<br>
полезным, но НЕ ДАЕМ НИКАКИХ ГАРАНТИЙ, даже подразумеваемой гарантии<br>
ПРИГОДНОСТИ К КУПЛЕ-ПРОДАЖЕ или ИСПОЛЬЗОВАНИЮ В КОНКРЕТНЫХ ЦЕЛЯХ<br>
(см. "Стандартную публичную лицензию GNU").<br>
Вместе с данной программой вы должны были получить копию "Стандартной<br>
публичной лицензии GNU"; если это не так, напишите в Free Software<br>
Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.<br>
<br>
(Суть: Вы можете модифицировать и программу и ее исходный код,<br>
но все модификации должны распространяться на таких же условиях, с
исходными кодами, свободно).</p>
Документация распространяется на условиях лицензии <a href="http://creativecommons.org/licenses/by-sa/3.0/">CreativeCommons BY-SA 3.0 license.</a><br>
<p>С благодарностью приму некоторую финансовую поддержку.</p>

<h2>Изменения
версий:</h2>
<ul>
  <li>Версия 0.1, 13 августа 2004 - первая публичная
(бета!).</li>
  <li>Версия 0.1.1, 18 августа
2004 - исправлена ошибка с пространственной частью YV12
(дистанция была 2 пиксела)
  </li>
  <li>Версия 0.2, 21 августа 2004 - 
  Добавлены более безопасные режимы modes=1-4, обновлена документация </li>
  <li>Версия 0.3, 28 августа 2004 - добавлена чересстрочная
обработка, реорганизация кода </li>
  <li>Версия 0.4, 10 сентября 2004 - исправлена возможная ошибка
с разными питчами кадров</li>
  <li>Версия 0.5, 23 марта 2005 - использовано более корректное
кэширование. Благодарность
Turyst04 за доклад о проблеме стабильности.</li>
  <li>Версия 0.6, 2 апреля 2005 - исправлена некоторая ошибка с
YUY2. Благодарность AVIL за доклад.</li>
  <li>Версия 0.7, 21 апреля 2005 - исправлена ошибка в режиме
mode=2 для YV12 чересстрочном;
исправлен питч первого кадра.</li>
  <li>Версия 0.7.0, 27 июля 2005 - только переформатирована
документация
  </li>
  <li>Версия 0.8, 9 октября 2005 - изменен диапазон кэша кадров до 3;<br>
                - добавлена опция <var>norow</var> чотобы отменить использования пары из той же строки кадра;<br>
		- исправлена ошибка документации о режиме <var>mode</var>=1; <br>
		- переименованы режимы 4 в 5, 3 в 4, 2 в 3, добавлен новый режим 2.

  <li>Версия 0.8.1 - 28 июля 2006 - Исправлена ошибка для mode>0, interlaced=true, norow=false, YV12. 
  Благодарность squid_80 за доклад.</li>
  </li>
  <li>Версия 0.8.2 - 7 октября 2006 - Исправлена ошибка зеленого правого бордюра для не кратной 8 ширине. 
  Благодарность akapuma за доклад.</li>
</ul>

<h3><a href="degrainmedian082.zip">Download
DeGrainMedian version 0.8.2</a></h3>


<p><a href="../">Вернуться на главную
страницу</a></p>
</body>
</html>
